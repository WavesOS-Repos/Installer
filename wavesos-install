#!/bin/bash

# WavesOS Installation Script - Main Entry Point
# A custom Arch Linux distribution installer
# Version: 3.0 - Modular Architecture

set -euo pipefail # Exit on error, undefined vars, pipe failures

# Source all library modules
SCRIPT_DIR="/usr/lib/wavesos-install"
source "$SCRIPT_DIR/utils.sh"
source "$SCRIPT_DIR/hardware.sh"
source "$SCRIPT_DIR/partitioning.sh"
source "$SCRIPT_DIR/system.sh"
source "$SCRIPT_DIR/desktop.sh"
source "$SCRIPT_DIR/bootloader.sh"

# Main installation function
main() {
    show_banner

    # Pre-installation checks
    check_root
    check_live_env
    check_tools
    check_network
    update_clock

    # Disk preparation
    detect_disks
    show_hardware
    select_disks
    detect_boot_mode
    configure_partitions
    confirm_partitioning

    # Disk operations
    create_partitions
    format_partitions
    mount_partitions

    # System installation
    update_mirrorlist
    install_base_system
    install_bootloader_packages
    install_graphics_drivers
    install_desktop_environment
    install_custom_packages
    copy_custom_repo
    generate_fstab

    # System configuration
    configure_system
    apply_chroot_config
    install_bootloader
    install_wavesos_customizations
    install_SDDM_theme
    install_gnome_extensions
    setup_kando_autostart
    set_burn_tvglitch_chroot
    configure_os_release
    set_default_WavesOS_theme

    # Final steps
    verify_installation
    cleanup_installation
    show_installation_summary
}

# Error handling
trap 'error "Installation interrupted by user or system error"' INT TERM

# Run main installation
main "$@"
